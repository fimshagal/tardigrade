/* Tardigrade store v1.1.8 */

/* Created by fSha | fimashagal@gmail.com */
           
/*
 * Creative Commons Attribution 4.0 International (CC BY 4.0)
 *
 * You are free to:
 *
 * - Share — copy and redistribute the material in any medium or format
 * - Adapt — remix, transform, and build upon the material for any purpose, even commercially.
 *
 * Under the following terms:
 *
 * - Attribution — You must give appropriate credit, provide a link to the license, and indicate if changes were made. You may do so in any reasonable manner, but not in any way that suggests the licensor endorses you or your use.
 */
(function(l,t){typeof exports=="object"&&typeof module<"u"?t(exports):typeof define=="function"&&define.amd?define(["exports"],t):(l=typeof globalThis<"u"?globalThis:l||self,t(l.TardigradeStore={}))})(this,function(l){"use strict";var g=Object.defineProperty;var L=(l,t,n)=>t in l?g(l,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[t]=n;var p=(l,t,n)=>(L(l,typeof t!="symbol"?t+"":t,n),n);var t=(i=>(i.Null="null",i.Undefined="undefined",i.Function="function",i.AsyncFunction="asyncfunction",i.Number="number",i.String="string",i.Boolean="boolean",i.Array="array",i.Object="object",i))(t||{});const n=i=>Object.prototype.toString.call(i).replace(/^\[object (.+)\]$/,"$1").toLowerCase(),c=i=>{const r=n(i);return r!=="null"&&r!=="undefined"},f=i=>{const r=n(i);return r==="string"||r==="number"||r==="symbol"},a=(i,r)=>Object.prototype.hasOwnProperty.call(i,r);class v{constructor(r,e){p(this,"_resolvers",{});p(this,"_props",{});p(this,"_resolverListenerHandlers",{});p(this,"_propListenerHandlers",{});p(this,"_listenerHandlers",[]);p(this,"_alive",!0);p(this,"_sessionKey",null);if(!r)throw Error("Tardigrade constructor error");this._sessionKey=r}addResolver(r,e){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}if(n(e)!==t.Function&&n(e)!==t.AsyncFunction){console.error("Tardigrade: resolver have to be a function");return}if(a(this._resolvers,r)){console.error("Tardigrade: resolver has been planted");return}this._resolvers[r]=e}setResolver(r,e){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}if(n(e)!==t.Function&&n(e)!==t.AsyncFunction){console.error("Tardigrade: resolver have to be a function");return}if(!a(this._resolvers,r)){console.error("Tardigrade: resolver has been planted");return}this._resolvers[r]=e}removeResolver(r){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}a(this._resolvers,r)&&(delete this._resolvers[r],delete this._resolverListenerHandlers[r])}async callResolver(r){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}if(!a(this._resolvers,r)){console.error("Tardigrade: this resolver hasn't been created yet or been deleted");return}const e=await this._resolvers[r](this.props);this.handleOnCallResolver(r,e),a(this._resolverListenerHandlers,r)&&this._resolverListenerHandlers[r].forEach(s=>s(e))}addResolverListener(r,e){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}if(!a(this._resolvers,r)){console.error(`Tardigrade: there is no resolver with name "${r}"`);return}a(this._resolverListenerHandlers,r)||(this._resolverListenerHandlers[r]=[]),this._resolverListenerHandlers[r].push(e)}removeResolverListener(r,e){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}a(this._resolverListenerHandlers,r)&&(this._resolverListenerHandlers[r]=this._resolverListenerHandlers[r].filter(s=>s!==e))}removeAllResolverListeners(r){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}a(this._resolverListenerHandlers,r)&&delete this._resolverListenerHandlers[r]}addProp(r,e){this.silentAddProp(r,e),this.handleOnSetProp(this._props[r])}removeProp(r){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}if(!this.hasProp(r)){console.error("Tardigrade: prop can't be deleted, you have to remove prop first");return}this.removeAllPropListeners(r),delete this._props[r]}setProp(r,e){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}if(!this.hasProp(r)){console.error(`Tardigrade: prop "${r}" wasn't registered. You have to add this prop first`);return}const s=(h,u)=>{this._props[h].value=u,this.handleOnSetProp(this._props[h])},o=this._props[r],d=n(e);if(!c(e)){s(r,null);return}if(o.type!==d){console.error(`Tardigrade: new value must have same type as initial value for prop "${r}"`);return}if(!o.isValueScalar)try{JSON.stringify(e)}catch{console.error("Tardigrade: complex data has to be json-friendly");return}s(r,e)}addPropListener(r,e){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}if(!this.hasProp(r)){console.error(`Tardigrade: prop "${r}" wasn't registered. You have to add this prop first`);return}this.isPropListened(r)||(this._propListenerHandlers[r]=[]),this._propListenerHandlers[r].push(e)}removePropListener(r,e){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}if(!this.isPropListened(r)){console.error(`Tardigrade: prop "${r}" doesn't have any listeners`);return}this._propListenerHandlers[r]=this._propListenerHandlers[r].filter(s=>s!==e)}removeAllPropListeners(r){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}if(!this.isPropListened(r)){console.warn(`Tardigrade: prop "${r}" doesn't have any listeners`);return}delete this._propListenerHandlers[r]}prop(r){if(!this._alive)return console.error("Tardigrade: this store doesn't support yet"),null;if(!this.hasProp(r))return console.error(`Tardigrade: prop "${r}" wasn't registered. You have to add this prop first`),null;const e=this._props[r];return e.isValueScalar?e.value:this.cloneComplexData(e.value)}hasProp(r){return this._alive?a(this._props,r):(console.error("Tardigrade: this store doesn't support yet"),!1)}addListener(r){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}this._listenerHandlers.push(r)}removeListener(r){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}this._listenerHandlers=this._listenerHandlers.filter(e=>e!==r)}removeAllListeners(){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}this._listenerHandlers=[]}importResolvers(r,e){const s=r.exportAllResolvers(this._sessionKey);this._resolvers=e?{...this._resolvers,...s}:{...s,...this._resolvers}}importProps(r,e){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}const s=r.props;Object.entries(s).forEach(([o,d])=>{if(this.hasProp(o)){if(!e)return;this.setProp(o,d)}else this.addProp(o,d)})}merge(r,e){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}const s=Object.keys(r.props);this.silentImportProps(r,e),this.importAllPropsListenerHandlers(r,e),this.importAllListenersHandlers(r,e),this.importResolvers(r,e),this.importAllResolversListenerHandlers(r,e),r.kill(this._sessionKey),s.forEach(o=>{this.handleOnSetProp(this._props[o])})}kill(r){if(r!==this._sessionKey||!this._alive)return;const e=Object.keys(this._props);this.removeAllListeners(),e.forEach(s=>{this.removeAllPropListeners(s),this.removeProp(s)}),this._alive=!1}exportAllPropsListenerHandlers(r){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}return r!==this._sessionKey?null:{...this._propListenerHandlers}}exportAllResolvers(r){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}return r!==this._sessionKey?null:{...this._resolvers}}exportAllResolversListenerHandlers(r){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}return r!==this._sessionKey?null:{...this._resolverListenerHandlers}}exportAllListenersHandlers(r){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}return r!==this._sessionKey?null:[...this._listenerHandlers]}silentImportProps(r,e){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}const s=r.props;Object.entries(s).forEach(([o,d])=>{if(this.hasProp(o)){if(!e)return;this.silentSetProp(o,d)}else this.silentAddProp(o,d)})}silentSetProp(r,e){if(!this.hasProp(r)){console.error(`Tardigrade: prop "${r}" wasn't registered. You have to add this prop first`);return}const s=(h,u)=>{this._props[h].value=u},o=this._props[r],d=n(e);if(!c(e)){s(r,null);return}if(o.type!==d){console.error(`Tardigrade: new value must have same type as initial value for prop "${r}"`);return}if(!o.isValueScalar)try{JSON.stringify(e)}catch{console.error("Tardigrade: complex data has to be json-friendly");return}s(r,e)}silentAddProp(r,e){if(!this._alive){console.error("Tardigrade: this store doesn't support yet");return}if(this.hasProp(r)){console.error("Tardigrade: prop can't be override, you have to remove prop first");return}if(!c(e)){console.error("Tardigrade: value can't be nullable");return}const s=n(e),o=f(e);if(o){this._props[r]={name:r,value:e,type:s,isValueScalar:o};return}try{JSON.stringify(e)}catch{console.error("Tardigrade: complex data has to be json-friendly");return}this._props[r]={name:r,value:e,type:s,isValueScalar:o}}importAllResolversListenerHandlers(r,e){const s=r.exportAllResolversListenerHandlers(this._sessionKey);this._propListenerHandlers=e?{...this._resolverListenerHandlers,...s}:{...s,...this._resolverListenerHandlers}}importAllPropsListenerHandlers(r,e){const s=r.exportAllPropsListenerHandlers(this._sessionKey);this._propListenerHandlers=e?{...this._propListenerHandlers,...s}:{...s,...this._propListenerHandlers}}importAllListenersHandlers(r,e){const s=r.exportAllListenersHandlers(this._sessionKey),o=[...this._listenerHandlers,...s];this._listenerHandlers=e?[...new Set(o)]:o}isPropListened(r){return a(this._propListenerHandlers,r)}handleOnCallResolver(r,e){for(const s of this._listenerHandlers)s(r,e,this.props)}handleOnSetProp(r){if(this.isPropListened(r.name))for(const e of this._propListenerHandlers[r.name])e(r.value);for(const e of this._listenerHandlers)e(r.name,r.value,this.props)}cloneComplexData(r){return JSON.parse(JSON.stringify(r))}get props(){if(!this._alive)return console.error("Tardigrade: this store doesn't support yet"),{};const r={};return Object.entries(this._props).forEach(([e,s])=>{r[e]=s.isValueScalar?s.value:this.cloneComplexData(s.value)}),r}}const _=(()=>Symbol(crypto.randomUUID()))();console.log("Tardigrade works!");const y=(i,r)=>{r=r||{};const e=new v(_,r);return i&&Object.entries(i).forEach(([s,o])=>{switch(n(o)){case t.Function:case t.AsyncFunction:e.addResolver(s,o);break;case t.Number:case t.String:case t.Boolean:case t.Array:case t.Object:e.addProp(s,o);break;case t.Null:case t.Undefined:default:console.warn(`Tardigrade: data item "${s}" has incorrect type`);break}}),e};l.createTardigrade=y,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
